import{p as b}from"./pako.esm-BpSz_pCI.js";import{q as L}from"./qrcode-BB1qHw6L.js";let c=[],h=1,I=1;const g=2e3,w=document.getElementById("add-section-btn"),m=document.getElementById("menu-sections"),S=document.getElementById("preview-iframe"),C=document.getElementById("size-display"),x=document.getElementById("size-warning"),u=document.getElementById("qr-code-img"),p=document.getElementById("qr-code-placeholder"),A=document.getElementById("save-json-btn"),B=document.getElementById("load-json-btn"),v=document.getElementById("json-file-input");async function M(t){const e=new TextEncoder,n=await crypto.subtle.importKey("raw",e.encode(t),{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e.encode("static-menu-qr-salt"),iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function R(t,e){const n=await M(e),i=crypto.getRandomValues(new Uint8Array(12)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},n,new TextEncoder().encode(t)),a=new Uint8Array(i.length+s.byteLength);return a.set(i),a.set(new Uint8Array(s),i.length),btoa(String.fromCharCode.apply(null,a))}function f(){m.innerHTML="",c.length===0&&(m.innerHTML='<p>No sections yet. Click "Add Section" to get started!</p>'),c.forEach(t=>{const e=document.createElement("div");e.className="menu-section",e.dataset.sectionId=t.id,e.innerHTML=`
      <div class="menu-section-header">
        <input type="text" class="section-name-input" placeholder="Section Name (e.g., Appetizers)" value="${t.name}">
        <button class="delete-section-btn" title="Delete Section"><i class="fas fa-trash"></i> Delete Section</button>
      </div>
      <div class="menu-items">
        <!-- Menu items will be rendered here -->
      </div>
      <button class="add-item-btn"><i class="fas fa-plus"></i> Add Menu Item</button>
    `;const n=e.querySelector(".menu-items");t.items.forEach(i=>{const s=E(i);n.appendChild(s)}),m.appendChild(e)}),l()}function E(t){const e=document.createElement("div");return e.className="menu-item",e.dataset.itemId=t.id,e.innerHTML=`
        <input type="text" class="item-name-input" placeholder="Item Name (e.g., Calamari)" value="${t.name}">
        <input type="text" class="item-price-input" placeholder="Price (e.g., $12.99)" value="${t.price}">
        <button class="delete-btn delete-item-btn" title="Delete Item"><i class="fas fa-times"></i></button>
        <input type="text" class="item-desc-input" placeholder="Description (e.g., served with marinara sauce)" value="${t.description}">
    `,e}async function l(){const t=await k();S.src=t||"about:blank";const e=t.length;if(C.textContent=`${e} characters`,x.hidden=e<=g,c.length>0&&e<=g)D(t),u.hidden=!1,p.style.display="none";else{u.src="",u.hidden=!0,p.style.display="flex";const n=p.querySelector("p");e>g?n.textContent="Menu is too large for a QR Code.":n.textContent="Your QR code will appear here."}}async function k(){if(c.length===0)return"";const t=new Date().toISOString();let e="ip_not_available";try{const y=await fetch("https://api.ipify.org?format=json");y.ok&&(e=(await y.json()).ip)}catch(y){console.error("Could not fetch IP address:",y)}const n=await R(e,t),s=JSON.stringify({menu:c,meta:{ts:t,eid:n}}),a=b.deflate(s),r=btoa(String.fromCharCode.apply(null,a)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");return`${new URL("menu.html",window.location.href).href}?data=${r}`}function D(t){try{const i=L(0,"L");i.addData(t),i.make(),u.src=i.createDataURL(10,5)}catch(e){console.error("Error generating QR code:",e);const n=p.querySelector("p");n.textContent="Could not generate QR code.",u.hidden=!0,p.style.display="flex"}}w.addEventListener("click",()=>{const t={id:`section-${h++}`,name:"",items:[]};c.push(t),f(),l()});m.addEventListener("click",t=>{const n=t.target.closest("button");if(n){if(n.classList.contains("delete-section-btn")){const i=n.closest(".menu-section");i.classList.add("hiding"),i.addEventListener("animationend",()=>{const s=i.dataset.sectionId;c=c.filter(a=>a.id!==s),f(),l()},{once:!0})}if(n.classList.contains("add-item-btn")){const i=n.closest(".menu-section").dataset.sectionId,s=c.find(o=>o.id===i),a={id:`item-${I++}`,name:"",price:"",description:""};s.items.push(a);const d=n.previousElementSibling,r=E(a);d.appendChild(r),l()}if(n.classList.contains("delete-item-btn")){const i=n.closest(".menu-item");i.classList.add("hiding"),i.addEventListener("animationend",()=>{const a=n.closest(".menu-section").dataset.sectionId,d=i.dataset.itemId,r=c.find(o=>o.id===a);r.items=r.items.filter(o=>o.id!==d),i.remove(),l()},{once:!0})}}});m.addEventListener("input",t=>{const e=t.target,n=e.closest(".menu-section");if(!n)return;const i=n.dataset.sectionId,s=c.find(a=>a.id===i);if(e.classList.contains("section-name-input")&&(s.name=e.value),e.classList.contains("item-name-input")||e.classList.contains("item-price-input")||e.classList.contains("item-desc-input")){const d=e.closest(".menu-item").dataset.itemId,r=s.items.find(o=>o.id===d);e.classList.contains("item-name-input")&&(r.name=e.value),e.classList.contains("item-price-input")&&(r.price=e.value),e.classList.contains("item-desc-input")&&(r.description=e.value)}l()});A.addEventListener("click",()=>{if(c.length===0){alert("Menu is empty. Nothing to save.");return}const t=JSON.stringify(c,null,2),e=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(e),i=document.createElement("a");i.href=n,i.download="menu.json",i.click(),URL.revokeObjectURL(n)});B.addEventListener("click",()=>{v.click()});v.addEventListener("change",t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=i=>{try{const s=JSON.parse(i.target.result);if(Array.isArray(s)&&s.every(a=>a.id&&a.name!==void 0&&Array.isArray(a.items))){c=s;const a=Math.max(0,...s.map(o=>parseInt(o.id.split("-")[1]||0))),d=s.flatMap(o=>o.items),r=Math.max(0,...d.map(o=>parseInt(o.id.split("-")[1]||0)));h=a+1,I=r+1,f(),l()}else alert("Invalid or corrupted JSON file.")}catch(s){alert("Error reading JSON file: "+s.message)}},n.readAsText(e),t.target.value=""});function N(){f(),l()}N();
